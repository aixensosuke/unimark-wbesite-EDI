rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // User authentication check
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if the user is logged out via forcedLogout flag
    function isForcedLogout(uid) {
      return exists(/databases/$(database)/documents/users/$(uid)/forcedLogout) && 
        get(/databases/$(database)/documents/users/$(uid)).data.forcedLogout == true;
    }
    
    // Combined auth check that accounts for forced logout
    function isAuthenticatedNotLoggedOut() {
      return isAuthenticated() && !isForcedLogout(request.auth.uid);
    }
    
    // Role checks
    function isAttendee() {
      return isAuthenticatedNotLoggedOut() && 
        exists(/databases/$(database)/documents/attendees/$(request.auth.uid));
    }
    
    function isSupervisor() {
      return isAuthenticatedNotLoggedOut() && 
        exists(/databases/$(database)/documents/supervisors/$(request.auth.uid));
    }
    
    function isOrganization() {
      return isAuthenticatedNotLoggedOut() && 
        exists(/databases/$(database)/documents/organizations/$(request.auth.uid));
    }
    
    function isAdmin() {
      return isAuthenticatedNotLoggedOut() && 
        get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.isAdmin == true;
    }
    
    function belongsToOrganization(orgId) {
      return isAuthenticatedNotLoggedOut() && 
        (isOrganization() && request.auth.uid == orgId || 
         isSupervisor() && get(/databases/$(database)/documents/supervisors/$(request.auth.uid)).data.organizationId == orgId);
    }
    
    // Main users collection for storing auth state
    match /users/{userId} {
      // Allow users to read their own data
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Allow users to create and update their own data
      allow create, update: if isAuthenticated() && request.auth.uid == userId;
      
      // Allow admin to read/write all user data
      allow read, write: if isAdmin();
      
      // Allow writing to forcedLogout field for their own user
      match /forcedLogout {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
      }
      
      // Cookie preferences
      match /cookiePreferences {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
      }
    }
    
    // User profiles
    match /attendees/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isSupervisor() || isOrganization() || isAdmin());
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow delete: if isAdmin();
      
      // Special case for forcedLogout field - always writable by the owner
      match /forcedLogout {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
      }
    }
    
    match /supervisors/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isOrganization() || isAdmin());
      allow create: if isOrganization() || isAdmin();
      allow update: if isAuthenticated() && (request.auth.uid == userId || 
        belongsToOrganization(resource.data.organizationId) || isAdmin());
      allow delete: if isOrganization() || isAdmin();
      
      // Special case for forcedLogout field - always writable by the owner
      match /forcedLogout {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
      }
    }
    
    match /organizations/{orgId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (request.auth.uid == orgId || isAdmin());
      allow delete: if isAdmin();
      
      // Special case for forcedLogout field - always writable by the owner
      match /forcedLogout {
        allow read, write: if isAuthenticated() && request.auth.uid == orgId;
      }
    }
    
    match /admins/{userId} {
      allow read, write: if isAdmin();
    }
    
    // Attendance records
    match /attendance/{recordId} {
      // Only attendee can create their own attendance
      allow create: if isAttendee() && 
        request.resource.data.attendeeId == request.auth.uid;
      
      // Attendee can read their own attendance
      // Supervisors can read attendance for their managed classes
      // Organization can read all attendance in their organization
      allow read: if isAuthenticated() && (
        (isAttendee() && resource.data.attendeeId == request.auth.uid) ||
        (isSupervisor() && resource.data.classId in get(/databases/$(database)/documents/supervisors/$(request.auth.uid)).data.managedClasses) ||
        (isOrganization() && belongsToOrganization(resource.data.organizationId)) ||
        isAdmin()
      );
      
      // Only supervisors and admins can update attendance records
      allow update: if isAuthenticated() && (
        isSupervisor() && resource.data.classId in get(/databases/$(database)/documents/supervisors/$(request.auth.uid)).data.managedClasses ||
        isAdmin()
      );
      
      // Only admins can delete attendance records
      allow delete: if isAdmin();
    }
    
    // Classes/Sessions
    match /classes/{classId} {
      allow read: if isAuthenticated();
      allow create: if isSupervisor() || isOrganization() || isAdmin();
      allow update: if isAuthenticated() && (
        isSupervisor() && resource.data.supervisorId == request.auth.uid ||
        isOrganization() && resource.data.organizationId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAuthenticated() && (
        isOrganization() && resource.data.organizationId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Class enrollments
    match /enrollments/{enrollmentId} {
      allow read: if isAuthenticated();
      allow create: if isSupervisor() || isOrganization() || isAdmin();
      allow update, delete: if isAuthenticated() && (
        isOrganization() && resource.data.organizationId == request.auth.uid ||
        isSupervisor() && resource.data.supervisorId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Settings and configurations
    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Attendance Sessions
    match /sessions/{sessionId} {
      // Allow read access to authenticated users
      allow read: if isAuthenticated();
      
      // Allow create access to supervisors and organizations
      allow create: if isAuthenticated() && (isSupervisor() || isOrganization() || isAdmin());
      
      // Allow update access to the creator (supervisor) or organization
      allow update: if isAuthenticated() && (
        (isSupervisor() && resource.data.createdBy == request.auth.uid) ||
        (isOrganization() && belongsToOrganization(resource.data.organizationId)) ||
        isAdmin()
      );
      
      // Allow delete access to the creator (supervisor) or organization
      allow delete: if isAuthenticated() && (
        (isSupervisor() && resource.data.createdBy == request.auth.uid) ||
        (isOrganization() && belongsToOrganization(resource.data.organizationId)) ||
        isAdmin()
      );
    }
    
    // Block access to all other documents by default
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
} 